var marker;
var circle;
var latitude;
var longitude;
var radius;


//Funzione di geolocalizzazione
function geoLocal(){
	//se il browser supporta geolocalizzazione
	if (navigator.geolocation){
		var options={timeout:5000}
    	navigator.geolocation.getCurrentPosition(showPosition, errorGettingPosition);
    }
	else {
		alert("Your browser don't support geolocation");
	}
}

//Trova la mia posizione
function showPosition (pos){
	
	//prendo le coordinate del coordinate di geolocalizzazione
	latitude = pos.coords.latitude;
	longitude = pos.coords.longitude;
	
	myPosition = new google.maps.LatLng(latitude, longitude);
	
	//date le coordinate, restituisce l'indirizzo e lo inserisce nel form del menu notify
	geocodePosition(myPosition);
	
	getMarker(myPosition)
		
	//inserisce il cerchio con centro in myPosition
	distanceWidget = new DistanceWidget(map, myPosition)
	radiusWidgetCheck = true;
	if (radius)
		range=radius;
	else 
		range=RADIUS
	
	radiusWidget.set('distance', range);
	radiusWidget.center_changed();
	$('#searchRange').val(range + " km ");

}

//Gestione errori
function errorGettingPosition(err) {

	if(err.code == 1) {
		console.log(lastLatitude)
		if(lastLatitude && lastLongitude)
			alternLoc()
		else
			centerLoc();
		alert("L'utente non ha autorizzato la geolocalizzazione");
	}
	else if(err.code == 2) {
		if(lastLatitude && lastLongitude)
			alternLoc()
		else
			centerLoc();
		alert("Posizione non disponibile");
	}
	else if(err.code == 3) {
		if(lastLatitude && lastLongitude)
			alternLoc()
		else
			centerLoc();
		alert("Timeout");
	}
	else {
		alert("ERRORE:" + err.message);
	}	
}

//Crea marker
function getMarker(myPosition){
	//se c'Ã¨ un marker precedente
	if(marker){
		marker.setMap(null);
		map.panTo(myPosition);
	}
	marker = new google.maps.Marker({
		map:map,
		draggable:true,
		animation: google.maps.Animation.DROP,
		position: myPosition
	});
	
	//se muovo il marker
	google.maps.event.addListener(marker,'dragend', dragMark)
}
//aggiorna la posizione
function dragMark(event){
	
	//salva le coordinate della mia nuova posizione
	lastLatitude = event.latLng.lat();
    lastLongitude = event.latLng.lng();

    var markerPosition = new google.maps.LatLng(lastLatitude, lastLongitude)

	map.panTo(markerPosition);

	// aggiorno l'indirizzo
    geocodePosition(markerPosition);
}

function alternLoc(){
	
	//prende coordinate dai cookie
	var newMarkPos = new google.maps.LatLng(lastLatitude, lastLongitude);
	
	getMarker(newMarkPos);
	
	distanceWidget = new DistanceWidget(map, newMarkPos);
	radiusWidgetCheck = true
	
	map.setCenter(newMarkPos);	
	geocodePosition(newMarkPos);
	
	//radiusWidget.set('distance', range);
	$('#searchRange').val(radius + " km ")
}
	
function centerLoc() {
		console.log("centerLoc")
		//prende posizione default
		var newMarkPos = cityCenter;
		
		getMarker(newMarkPos);
		distanceWidget = new DistanceWidget(map, newMarkPos);
		radiusWidgetCheck = true;
	
		radiusWidget.set('distance', RADIUS);
		radiusWidget.center_changed();
		
		map.setCenter(cityCenter);
		geocodePosition(cityCenter);
}

/**
* Get address from coordinates
* @param latlng point
* ASYNCHRONOUS
*/
function geocodePosition(position){
	geocoder.geocode({'latLng': position}, function(results, status) {
		if (status == google.maps.GeocoderStatus.OK) { 
			// SUCCESS: get the first matching address and format it properly
			var address = results && results[1] ? results[0].address_components[1].long_name + ", " + results[0].address_components[0].long_name: position,
			lastAddress = results[0].address_components;
			if(address == position)
				geocodePosition(position); //Retry if Geocoder fails
			else{
				$('#notifyAddress').val(address);
				$('#searchAddress').val(address);
			}
		}
		else if (status === google.maps.GeocoderStatus.OVER_QUERY_LIMIT) {    
		    setTimeout(function() {
		        geocodePosition(position);
		    }, 200);
        }
		else {
		  console.log('Geocoder failed due to: ' + status);
		}
	});
}

//Setta gli indirizzi degli eventi in tabella ricorsivamente
function setTableAddress(events, actual, last, timeout, table_count) {
	
	geocoder = new google.maps.Geocoder();
	
	var llat, llng;

	llat = events[actual].locations[0].lat; 
	llng = events[actual].locations[0].lng;
	//console.log(llat);
	//console.log(llng);


	var LatLng = new google.maps.LatLng(llat, llng);
	
	geocoder.geocode({'latLng': LatLng}, function(results, status) {
    		if (status == google.maps.GeocoderStatus.OK) {		
			if (results[0]) {
				res = results[0].formatted_address;
				/*
				res = results[0].address_components[1].long_name + " n." +
				      results[0].address_components[0].long_name + ", " +
				      results[0].address_components[2].long_name;*/
			}
			else res = "Indirizzo non trovato.";
		}
		else { 
			if ( (timeout < 16) && status == google.maps.GeocoderStatus.OVER_QUERY_LIMIT) {
				setTimeout(function(){ setTableAddress(events, actual, last, (timeout+1), table_count); }, 425);
				return;
			}
			else {
				/*
				var ih = $("#tableEventAddress" + (actual + table_count)).html();
				if (ih == "<img src=\"img/ajax-loader.gif\">") res = "Ricerca indirizzo fallita. Causa: " + status;
				else res = ih;*/
				console.log("errore");
			}		
		}
		 console.log(res);
		$("#tableEventAddress" + (actual + table_count)).html(res);//
		if (actual < last) setTimeout(function(){ setTableAddress(events, actual+1, last, 0, table_count); }, 450);
	});
}

